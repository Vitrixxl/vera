<div class="flex flex-col h-screen font-sans text-[#000000] bg-cover bg-center"
     style="background-image: url('/images/background.jpg'); background-color: #F5ECDE;">
      
  <header class="flex-none px-6 py-4 border-b border-black flex justify-between items-center bg-transparent z-10">
    <img src="/images/vera-icon.png" alt="Vera Logo" class="h-8 w-auto">
  </header>

  <main class="flex-1 overflow-y-auto p-4 relative flex flex-col items-center">
    
    <div class="w-full max-w-3xl space-y-6 pb-4">
      
      @if (messages().length === 0) {
        <div class="flex flex-col items-center justify-center h-64 text-center opacity-40">
          <svg width="43" height="43" viewBox="0 0 43 43" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M24.3845 42.346C24.8776 42.3034 25.2951 41.9633 25.432 41.4876L27.469 36.3166C27.9592 34.6127 27.4441 35.1733 26.7272 33.5518C26.3559 32.7117 26.0082 31.9185 25.7056 31.2281C25.1705 30.007 24.7762 29.1074 24.6408 28.8388L16.7851 13.8738C16.2291 12.7121 15.6911 11.6903 15.2176 10.791C13.1658 6.89381 12.3258 5.2983 16.4869 4.59854C17.8106 4.40044 18.4257 3.76077 18.3467 2.84587C18.2677 1.93096 17.4688 1.4134 16.2211 1.52115L1.49818 2.79259C-0.581331 2.97218 -0.503482 5.81442 1.7783 6.03634C3.55382 6.21818 6.0008 8.35308 8.9661 14.5491L22.7868 41.3109C23.1841 42.0306 23.7191 42.4034 24.3845 42.346Z" fill="black"/>
            <path d="M39.6757 15.8308C40.4021 14.9892 42.3894 11.9201 42.3345 9.4787C42.3345 3.91101 37.6348 -0.121948 32.0893 0.0028169C26.5439 0.127582 22.1399 4.91715 22.2527 9.93052C22.3655 14.9439 26.9524 18.9069 32.4978 18.7821C32.6926 18.7777 32.886 18.7684 33.0778 18.7541C33.0365 18.9421 32.9896 19.1369 32.9373 19.3388C32.622 20.554 31.4506 23.3478 31.3519 23.6213C30.8188 24.7785 32.3765 25.7443 33.176 24.7522L39.6757 15.8308Z" fill="black"/>
          </svg>
          <p class="font-medium mt-2">Pose une question à Vera</p>
        </div>
      }

      @for (message of messages(); track message.id) {
        @if (message.role === 'user') {
          <div class="flex justify-end w-full animate-in fade-in slide-in-from-bottom-2">
            <div class="max-w-[85%] bg-[#FFE4E6] px-5 py-4 rounded-2xl rounded-br-none border border-black shadow-sm">
              <p class="whitespace-pre-wrap text-base leading-relaxed font-bold text-black">{{ message.content }}</p>
            </div>
          </div>
        }

        @if (message.role === 'assistant') {
          <div class="flex justify-start w-full gap-3 animate-in fade-in slide-in-from-bottom-2">
            <div class="flex-shrink-0 w-10 h-10 rounded-full overflow-hidden bg-black mt-1 border border-gray-200">
              <img src="/images/vera-chat.png" alt="Vera" class="w-full h-full object-cover">
            </div>
            <div class="flex flex-col max-w-[85%]">
              <div class="bg-white px-5 py-4 rounded-2xl rounded-tl-none border border-black shadow-sm">
                @if (message.steps && message.steps.length > 0) {
                  <div class="mb-3 space-y-2">
                    @for (step of message.steps; track $index; let last = $last) {
                      <div class="flex items-center gap-2">
                        @if (last && message.isStreaming) {
                          <div class="w-4 h-4 flex-shrink-0">
                            <svg class="animate-spin w-4 h-4 text-[#8B5CF6]" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                          </div>
                        } @else {
                          <div class="w-4 h-4 flex-shrink-0 rounded-full bg-[#DBF9BE] flex items-center justify-center">
                            <svg class="w-2.5 h-2.5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                          </div>
                        }
                        <span class="text-xs text-gray-500 font-medium">{{ step }}</span>
                      </div>
                    }
                  </div>
                }
                <div class="text-base leading-relaxed min-h-[1.5em] font-bold text-black space-y-2">
                   @for (line of message.content.split('\n'); track $index) {
                     @if (line.trim()) {
                       <p>{{ line }}</p>
                     }
                   }
                </div>
              </div>
            </div>
          </div>
        }
      }
      
      @if (isLoading() && messages()[messages().length - 1]?.role === 'user') {
         <div class="flex justify-start w-full gap-3 animate-in fade-in slide-in-from-bottom-2">
            <div class="relative mt-2">
               <div class="w-10 h-10 rounded-full overflow-hidden bg-black border border-gray-200">
                  <img src="/images/vera-chat.png" alt="Vera" class="w-full h-full object-cover">
               </div>
               
               <div class="absolute -top-3 -right-3 flex items-center space-x-1 bg-black px-2 py-1.5 rounded-full shadow-md z-10 border border-black">
                  <div class="w-1.5 h-1.5 bg-white rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                  <div class="w-1.5 h-1.5 bg-white rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                  <div class="w-1.5 h-1.5 bg-white rounded-full animate-bounce"></div>
               </div>
            </div>
         </div>
      }
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="flex-none bg-transparent p-4 pb-6">
    <div class="max-w-3xl mx-auto w-full">
      
      @if (selectedFiles().length > 0) {
        <div class="flex gap-2 mb-2 overflow-x-auto px-2">
          @for (file of selectedFiles(); track file.name) {
            <div class="bg-white px-3 py-1 rounded-lg text-xs border border-gray-200 flex items-center gap-2 shadow-sm">
              <span class="truncate max-w-[150px]">{{ file.name }}</span>
              <button (click)="removeFile(file)" class="text-red-400 hover:text-red-600">×</button>
            </div>
          }
        </div>
      }

      @if (showUrlInput()) {
         <div class="mb-2 bg-white rounded-xl p-2 flex gap-2 shadow-sm border border-gray-200 animate-in slide-in-from-bottom-2">
           <input [(ngModel)]="urlInput" type="url" placeholder="https://..." class="flex-1 outline-none text-sm px-2">
           <button (click)="addFromUrl()" class="text-xs bg-black text-white px-3 py-1 rounded-lg">Add</button>
         </div>
      }

      <div class="flex items-stretch gap-3">
        <button
          (click)="toggleVoiceRecognition()"
          [class]="'flex-shrink-0 px-4 rounded-[2rem] flex items-center justify-center transition-all shadow-md ' +
            (isRecording() ? 'bg-red-500 hover:bg-red-600 animate-pulse' : 'bg-black hover:bg-gray-800')"
          class="text-white"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
          </svg>
        </button>

        <div class="flex-1 flex items-center gap-2 shadow-sm rounded-[2rem] bg-white transition-shadow focus-within:shadow-md border border-transparent focus-within:border-gray-200 px-3 py-2">
          <div class="flex items-center gap-1 flex-shrink-0">
             <input type="file" #fileInput (change)="onFileSelected($event)" multiple class="hidden" [accept]="ACCEPTED_MIME_TYPES.join(',')">
             <button (click)="fileInput.click()" class="p-2 text-gray-400 hover:text-black rounded-full hover:bg-gray-100 transition-colors" title="Ajouter fichier">
               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
             </button>
             <button (click)="toggleUrlInput()" class="p-2 text-gray-400 hover:text-black rounded-full hover:bg-gray-100 transition-colors" title="Ajouter Lien">
               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
             </button>
          </div>
          <textarea
            [(ngModel)]="inputText"
            (keydown.enter)="handleSubmit($any($event))"
            (paste)="onPaste($any($event))"
            placeholder="Ecrivez ici..."
            rows="1"
            class="flex-1 py-2 bg-transparent resize-none outline-none text-gray-800 placeholder-gray-400 max-h-32"
            style="min-height: 40px;"
          ></textarea>
          <button
            (click)="handleSubmit()"
            [disabled]="!inputText.trim() && selectedFiles().length === 0"
            class="p-2 rounded-full transition-colors disabled:opacity-30 disabled:cursor-not-allowed hover:bg-gray-100 flex-shrink-0"
          >
            <svg class="w-6 h-6 text-black transform rotate-90" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="text-center mt-4">
          <p class="text-xs text-gray-500">
            Pour soutenir Vera, répond à ce <a href="#" (click)="$event.preventDefault(); goToSurvey()" class="underline hover:text-black">sondage</a>
          </p>
      </div>
    </div>
  </footer>
</div>